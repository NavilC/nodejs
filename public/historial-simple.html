<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Historial De Envios</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <link rel="stylesheet" href="historial-simple.css">
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-history"></i> Historial de Envíos</h1>
      <a href="index.html" class="btn"><i class="fas fa-arrow-left"></i> Volver al formulario</a>
    </header>

    <div id="container"></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const API_BASE_URL = 'http://localhost:3000/api';

    async function fetchData(endpoint) {
      const res = await fetch(API_BASE_URL + '/' + endpoint);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      return json.data || json;
    }

    async function postData(endpoint, data) {
      const res = await fetch(API_BASE_URL + '/' + endpoint, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({message:'unknown'}));
        throw new Error(err.message || 'Error POST');
      }
      return await res.json();
    }

    async function putData(endpoint, id, data) {
      const res = await fetch(API_BASE_URL + '/' + endpoint + '/' + id, {
        method: 'PUT', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      if (!res.ok) {
        const err = await res.json().catch(()=>({message:'unknown'}));
        throw new Error(err.message || 'Error PUT');
      }
      return await res.json();
    }

    function el(tag, text) { const n = document.createElement(tag); if (text) n.textContent = text; return n; }

    async function load() {
      const container = document.getElementById('container');
      container.innerHTML = 'Cargando...';
      try {
        const pases = await fetchData('pase-salida');
        if (!pases || pases.length === 0) {
          container.innerHTML = '<p>No hay envíos registrados</p>';
          return;
        }
        container.innerHTML = '';
        pases.forEach(pase => {
          // Crear tarjeta usando las clases del CSS
          const card = document.createElement('div'); 
          card.className = 'card';

          // Header
          const header = document.createElement('div'); 
          header.className = 'card-header';
          
          const title = document.createElement('div'); 
          title.className = 'card-title'; 
          title.innerHTML = `<i class="fas fa-shipping-fast"></i> Pase #${pase.id} - ${pase.proyecto_nombre || ''}`;
          
          const headerRight = document.createElement('div');
          headerRight.style.display = 'flex'; 
          headerRight.style.alignItems = 'center'; 
          headerRight.style.gap = '12px';
          
          const dateDiv = document.createElement('div'); 
          dateDiv.className = 'card-date'; 
          dateDiv.innerHTML = `<i class="far fa-clock"></i> ${pase.created_at ? new Date(pase.created_at).toLocaleString() : 'N/A'}`;
          
          const modifyBtn = document.createElement('button'); 
          modifyBtn.className = 'btn'; 
          modifyBtn.innerHTML = '<i class="fas fa-edit"></i> Modificar';
          
          headerRight.appendChild(dateDiv); 
          headerRight.appendChild(modifyBtn);
          header.appendChild(title); 
          header.appendChild(headerRight);

          // Body
          const body = document.createElement('div'); 
          body.className = 'card-body';
          
          const infoGrid = document.createElement('div'); 
          infoGrid.className = 'info-grid';
          
          const infoUsuario = document.createElement('div'); 
          infoUsuario.className = 'info-item'; 
          infoUsuario.innerHTML = `<span class="info-label">Usuario</span><span class="info-value">${pase.usuario_nombre || 'N/A'}</span>`;
          
          const infoOrden = document.createElement('div'); 
          infoOrden.className = 'info-item'; 
          infoOrden.innerHTML = `<span class="info-label">Orden de Venta</span><span class="info-value">${pase.orden_venta || 'N/A'}</span>`;
          
          const infoProyecto = document.createElement('div'); 
          infoProyecto.className = 'info-item'; 
          infoProyecto.innerHTML = `<span class="info-label">Proyecto</span><span class="info-value">${pase.proyecto_nombre || ''}</span>`;
          
          const infoEstado = document.createElement('div'); 
          infoEstado.className = 'info-item'; 
          infoEstado.innerHTML = `<span class="info-label">Estado</span><span class="info-value"><span class="status-badge status-active">Activo</span></span>`;
          
          infoGrid.appendChild(infoUsuario); 
          infoGrid.appendChild(infoOrden); 
          infoGrid.appendChild(infoProyecto); 
          infoGrid.appendChild(infoEstado);
          body.appendChild(infoGrid);

          // Formulario inline
          const form = document.createElement('form'); 
          form.id = 'form-'+pase.id; 
          form.style.display = 'none'; 
          form.className = 'form-inline';
          
          const row = document.createElement('div'); 
          row.className = 'form-row';
          
          const g1 = document.createElement('div'); 
          g1.className = 'form-group'; 
          const label1 = document.createElement('label'); 
          label1.className = 'form-label'; 
          label1.textContent = 'Proyecto'; 
          const inProyecto = document.createElement('input'); 
          inProyecto.className='form-input'; 
          inProyecto.name='proyecto'; 
          inProyecto.placeholder='Nombre proyecto'; 
          inProyecto.value = pase.proyecto_nombre || ''; 
          g1.appendChild(label1); 
          g1.appendChild(inProyecto);
          
          const g2 = document.createElement('div'); 
          g2.className = 'form-group'; 
          const label2 = document.createElement('label'); 
          label2.className='form-label'; 
          label2.textContent='Orden de Venta'; 
          const inOrden = document.createElement('input'); 
          inOrden.className='form-input'; 
          inOrden.name='orden'; 
          inOrden.placeholder='Orden de Venta'; 
          inOrden.value = pase.orden_venta || ''; 
          g2.appendChild(label2); 
          g2.appendChild(inOrden);
          
          const g3 = document.createElement('div'); 
          g3.className = 'form-group'; 
          const label3 = document.createElement('label'); 
          label3.className='form-label'; 
          label3.textContent='Usuario'; 
          const inUsuario = document.createElement('input'); 
          inUsuario.className='form-input'; 
          inUsuario.name='usuario'; 
          inUsuario.placeholder='Nombre usuario'; 
          inUsuario.value = pase.usuario_nombre || ''; 
          g3.appendChild(label3); 
          g3.appendChild(inUsuario);
          
          const g4 = document.createElement('div'); 
          g4.className = 'form-group'; 
          const label4 = document.createElement('label'); 
          label4.className='form-label'; 
          label4.textContent='Fecha (no se envía al servidor)'; 
          const inFecha = document.createElement('input'); 
          inFecha.className='form-input'; 
          inFecha.type='date'; 
          inFecha.name='fecha'; 
          if (pase.created_at) inFecha.value = new Date(pase.created_at).toISOString().split('T')[0]; 
          g4.appendChild(label4); 
          g4.appendChild(inFecha);
          
          row.appendChild(g1); 
          row.appendChild(g2); 
          row.appendChild(g3); 
          row.appendChild(g4);
          form.appendChild(row);
          
          const actions = document.createElement('div'); 
          actions.className='form-actions'; 
          const save = document.createElement('button'); 
          save.className='btn'; 
          save.type='submit'; 
          save.innerHTML='<i class="fas fa-save"></i> Guardar'; 
          const cancel = document.createElement('button'); 
          cancel.className='btn btn-secondary'; 
          cancel.type='button'; 
          cancel.innerHTML='<i class="fas fa-times"></i> Cancelar'; 
          cancel.onclick = (e)=>{ e.preventDefault(); form.style.display='none'; };
          
          actions.appendChild(save); 
          actions.appendChild(cancel); 
          form.appendChild(actions);

          // Comportamiento onsubmit
          form.onsubmit = async (e)=>{
            e.preventDefault();
            try {
              save.disabled = true;
              const proyectos = await fetchData('proyectos');
              let proyecto = proyectos.find(p=>p.Nombre === inProyecto.value || String(p['Orden de Venta']) === inOrden.value);
              let proyectoId;
              if (proyecto) proyectoId = proyecto.id;
              else {
                const resp = await postData('proyectos', { 'Orden de Venta': inOrden.value ? parseInt(inOrden.value):0, Nombre: inProyecto.value || 'Sin nombre', SEC: 0 });
                proyectoId = resp.data ? resp.data.id : resp.data;
              }
              const usuarios = await fetchData('usuarios');
              let usuario = usuarios.find(u=>u.Nombre === inUsuario.value);
              let usuarioId;
              if (usuario) usuarioId = usuario.id;
              else {
                const r = await postData('usuarios', { Nombre: inUsuario.value || 'Usuario', Rol: 'Usuario' });
                usuarioId = r.data ? r.data.id : r.data;
              }
              await putData('pase-salida', pase.id, { idProyecto: proyectoId, idUsuarios: usuarioId });
              await updateDetallesOnSave(pase.id);
              showToast('Actualizado correctamente', 'success');
              load();
            } catch(err){ showToast('Error: '+err.message, 'error'); } finally { save.disabled = false; }
          };

          // Contenedor para detalles (piezas)
          const detallesContainer = document.createElement('div'); 
          detallesContainer.id = 'detalles-container-' + pase.id; 
          detallesContainer.style.marginTop = '8px'; 
          detallesContainer.style.display = 'none';

          body.appendChild(form);
          body.appendChild(detallesContainer);
          card.appendChild(header); 
          card.appendChild(body);
          container.appendChild(card);

          // Toggle del formulario al pulsar el botón
          modifyBtn.onclick = () => {
            // Cerrar otros formularios y detalles abiertos
            document.querySelectorAll('form[id^="form-"]').forEach(ff => { if (ff.id !== 'form-'+pase.id) ff.style.display = 'none'; });
            document.querySelectorAll('[id^="detalles-container-"]').forEach(dc => { if (dc.id !== 'detalles-container-'+pase.id) dc.style.display = 'none'; });
            const willOpen = (form.style.display === 'none');
            form.style.display = willOpen ? 'block' : 'none';
            if (willOpen) {
              if (detallesContainer && detallesContainer.style.display !== 'block') toggleDetalles(pase.id);
            } else { if (detallesContainer) detallesContainer.style.display = 'none'; }
          };
        });

        // Toggle y carga de detalles (piezas) para un pase
        async function toggleDetalles(paseId) {
          const cont = document.getElementById('detalles-container-' + paseId);
          if (!cont) return;
          if (cont.style.display === 'block') { cont.style.display = 'none'; return; }
          cont.innerHTML = 'Cargando piezas...';
          cont.style.display = 'block';
          try {
            // Intentar obtener detalles via /pase-salida/:id/detalles
            const res = await fetch(API_BASE_URL + '/pase-salida/' + paseId + '/detalles');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const json = await res.json();
            const detalles = json.data || json;
            renderDetalles(cont, paseId, detalles);
          } catch (err) {
            console.error(err);
            cont.innerHTML = '<div>Error cargando piezas: '+err.message+'</div>';
          }
        }

        function renderDetalles(container, paseId, detalles) {
          container.innerHTML = '';
          
          // Título de la sección
          const title = document.createElement('h3');
          title.innerHTML = '<i class="fas fa-boxes"></i> Piezas';
          container.appendChild(title);
          
          const piecesList = document.createElement('div');
          piecesList.className = 'pieces-list';
          
          if (!detalles || detalles.length === 0) {
            piecesList.innerHTML = '<p>No hay piezas en este pase</p>';
          } else {
            detalles.forEach(d => {
              const pieceItem = document.createElement('div');
              pieceItem.className = 'piece-item';
              
              // Info de la pieza
              const pieceInfo = document.createElement('div');
              pieceInfo.className = 'piece-info';
              
              const pieceName = document.createElement('span');
              pieceName.className = 'piece-name';
              pieceName.textContent = `${d.pieza_tipo || d.Tipo || 'Pieza'} - ${d.pieza_marca || d.Marca || ''}`;
              
              const pieceDetails = document.createElement('span');
              pieceDetails.className = 'piece-details';
              
              // Input para editar cantidad
              const qtyInput = document.createElement('input');
              qtyInput.type = 'number';
              qtyInput.min = '1';
              qtyInput.value = (d.Cantidad != null ? d.Cantidad : 1);
              qtyInput.className = 'form-input';
              qtyInput.style.width = '80px';
              // Marcar cantidad original y referencias para detectar cambios al guardar
              qtyInput.dataset.original = String(d.Cantidad != null ? d.Cantidad : 1);
              qtyInput.dataset.detalleId = String(d.id);
              qtyInput.dataset.detallePiezaId = String(d.idDetallePieza);
              
              pieceDetails.appendChild(document.createTextNode('Cantidad: '));
              pieceDetails.appendChild(qtyInput);
              
              pieceInfo.appendChild(pieceName);
              pieceInfo.appendChild(pieceDetails);
              
              // Botón eliminar
              const pieceActions = document.createElement('div');
              pieceActions.className = 'piece-actions';
              
              const del = document.createElement('button'); 
              del.className = 'btn-icon'; 
              del.title = 'Eliminar';
              del.innerHTML = '<i class="fas fa-trash"></i>';
              del.onclick = async () => {
                if (!confirm('Eliminar esta pieza del pase?')) return;
                try {
                  const r = await fetch(API_BASE_URL + '/pase-salida-detalle/' + d.id, { method: 'DELETE' });
                  if (!r.ok) throw new Error('HTTP ' + r.status);
                  showToast('Eliminado', 'success');
                  toggleDetalles(paseId); // recargar
                } catch(e){ showToast('Error: '+e.message, 'error'); }
              };
              
              pieceActions.appendChild(del);
              
              pieceItem.appendChild(pieceInfo);
              pieceItem.appendChild(pieceActions);
              piecesList.appendChild(pieceItem);
            });
          }
          
          container.appendChild(piecesList);

          // Form para añadir nueva pieza
          const addForm = document.createElement('div');
          addForm.className = 'add-piece-form';
          
          const formTitle = document.createElement('h4');
          formTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Agregar Pieza';
          addForm.appendChild(formTitle);
          
          const formRow = document.createElement('div');
          formRow.className = 'form-row';
          
          const tipoGroup = document.createElement('div');
          tipoGroup.className = 'form-group';
          const tipoLabel = document.createElement('label');
          tipoLabel.className = 'form-label';
          tipoLabel.textContent = 'Tipo de pieza';
          const inTipo = document.createElement('input'); 
          inTipo.className = 'form-input';
          inTipo.placeholder='Tipo de pieza'; 
          inTipo.required=true;
          tipoGroup.appendChild(tipoLabel);
          tipoGroup.appendChild(inTipo);
          
          const marcaGroup = document.createElement('div');
          marcaGroup.className = 'form-group';
          const marcaLabel = document.createElement('label');
          marcaLabel.className = 'form-label';
          marcaLabel.textContent = 'Marca';
          const inMarca = document.createElement('input'); 
          inMarca.className = 'form-input';
          inMarca.placeholder='Marca'; 
          inMarca.required=true;
          marcaGroup.appendChild(marcaLabel);
          marcaGroup.appendChild(inMarca);
          
          const cantGroup = document.createElement('div');
          cantGroup.className = 'form-group';
          const cantLabel = document.createElement('label');
          cantLabel.className = 'form-label';
          cantLabel.textContent = 'Cantidad';
          const inCant = document.createElement('input'); 
          inCant.className = 'form-input';
          inCant.type='number'; 
          inCant.min='1'; 
          inCant.placeholder='Cantidad'; 
          inCant.required=true;
          cantGroup.appendChild(cantLabel);
          cantGroup.appendChild(inCant);
          
          formRow.appendChild(tipoGroup);
          formRow.appendChild(marcaGroup);
          formRow.appendChild(cantGroup);
          addForm.appendChild(formRow);
          
          const addBtn = document.createElement('button'); 
          addBtn.className = 'btn';
          addBtn.innerHTML = '<i class="fas fa-plus"></i> Agregar pieza';
          
          addForm.appendChild(addBtn);
          container.appendChild(addForm);

          // Evento para agregar pieza
          addForm.onsubmit = async (e) => {
            e.preventDefault();
            try {
              addBtn.disabled = true;
              // Buscar o crear detalle-pieza
              const piezasRes = await fetch(API_BASE_URL + '/detalle-pieza');
              if (!piezasRes.ok) throw new Error('HTTP ' + piezasRes.status);
              const piezasJson = await piezasRes.json();
              const piezas = piezasJson.data || piezasJson;
              let pieza = piezas.find(p=> p.Tipo === inTipo.value && p.Marca === inMarca.value);
              let piezaId;
              if (pieza) piezaId = pieza.id;
              else {
                const createResp = await fetch(API_BASE_URL + '/detalle-pieza', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ cantidad: parseInt(inCant.value), Tipo: inTipo.value, Marca: inMarca.value }) });
                if (!createResp.ok) throw new Error('HTTP ' + createResp.status);
                const createJson = await createResp.json();
                piezaId = createJson.data ? createJson.data.id : createJson.data;
              }
              // Crear pase-salida-detalle
              const createDetalle = await fetch(API_BASE_URL + '/pase-salida-detalle', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ idPaseSalida: paseId, idDetallePieza: piezaId, Cantidad: parseInt(inCant.value) }) });
              if (!createDetalle.ok) throw new Error('HTTP ' + createDetalle.status);
              showToast('Pieza añadida', 'success');
              inTipo.value=''; inMarca.value=''; inCant.value='';
              toggleDetalles(paseId);
            } catch (err) {
              showToast('Error: '+err.message, 'error');
            } finally { addBtn.disabled = false; }
          };
          
          // Convertir en formulario funcional
          addBtn.onclick = () => addForm.onsubmit({preventDefault: () => {}});
        }
      } catch (e) {
        console.error(e);
        document.getElementById('container').innerHTML = '<p>Error cargando historial: '+e.message+'</p>';
      }
    }

    load();

    // Simple toast implementation
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const node = document.createElement('div');
      node.className = 'toast ' + type;
      node.textContent = message;
      container.appendChild(node);
      // animar
      requestAnimationFrame(()=> node.classList.add('show'));
      // eliminar después de 3s
      setTimeout(()=>{
        node.classList.remove('show');
        setTimeout(()=> container.removeChild(node), 300);
      }, 3000);
    }

    // Actualiza todas las cantidades modificadas de los detalles para un pase
    async function updateDetallesOnSave(paseId) {
      const cont = document.getElementById('detalles-container-' + paseId);
      if (!cont) return;
      // Buscar inputs numéricos dentro del contenedor que tengan dataset.detalleId
      const inputs = Array.from(cont.querySelectorAll('input[type="number"][data-detalle-id]'));
      const updates = [];
      for (const inp of inputs) {
        const orig = parseInt(inp.dataset.original || '0');
        const now = parseInt(inp.value) || 0;
        if (now !== orig) {
          const detalleId = inp.dataset.detalleId;
          const detallePiezaId = inp.dataset.detallePiezaId;
          if (!detalleId || !detallePiezaId) continue;
          if (now <= 0) { showToast('La cantidad debe ser mayor que 0', 'warning'); return; }
          updates.push({ id: detalleId, Cantidad: now, detallePiezaId: detallePiezaId });
        }
      }
      if (updates.length === 0) return; // nada que hacer
      showToast(`Actualizando ${updates.length} detalle(s)...`, 'success');
      // Ejecutar los PUTs secuencialmente para mayor compatibilidad con el servidor
      for (const u of updates) {
        // enviar payload completo requerido por la API (asegurar números)
        const payload = { idPaseSalida: parseInt(paseId), idDetallePieza: parseInt(u.detallePiezaId), Cantidad: parseInt(u.Cantidad) };
        console.log('PUT detalle', u.id, payload);
        try {
          const r = await fetch(API_BASE_URL + '/pase-salida-detalle/' + u.id, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          const text = await r.text().catch(()=>null);
          let body = null;
          try { body = text ? JSON.parse(text) : null; } catch(e) { body = text; }
          if (!r.ok) {
            showToast('Error actualizando detalle: ' + (r.status) + ' ' + (body && body.message ? body.message : JSON.stringify(body)), 'error');
            console.error('PUT detalle fallo', u.id, payload, body);
            throw new Error('HTTP ' + r.status + ' - ' + JSON.stringify(body));
          }
          // Si todo bien, actualizar data-original del input
          const inp = cont.querySelector(`input[data-detalle-id="${u.id}"]`);
          if (inp) inp.dataset.original = String(u.Cantidad);
        } catch(err) {
          console.error('Error updating detalle PUT:', err);
          throw err; // detener procesamiento y mostrar error
        }
      }
      // recargar detalles
      await toggleDetalles(paseId);
      showToast('Detalles actualizados correctamente', 'success');
    }
  </script>
</body>
</html>